(this.webpackJsonplocria=this.webpackJsonplocria||[]).push([[0],{25:function(e,t,n){e.exports=n(68)},30:function(e,t,n){},68:function(e,t,n){"use strict";n.r(t);var o=n(0),a=n.n(o),r=n(9),i=n.n(r),c=(n(30),n(10)),s=n(1),u=n(2),l=n(22),m=n(23);var d=Object(m.a)((function(e,t){return{osmd:{instance:null,connected:!1,loaded:!1},midi:{instance:null,connected:!1,loaded:!1,envelopes:[],playing:!1},actions:{osmdUpdate:function(n){e({osmd:Object(u.a)(Object(u.a)({},t().osmd),n)})},osmdConnect:function(e){console.log("[OSMD] attaching osmd to div",e),t().actions.osmdUpdate({instance:new l.OpenSheetMusicDisplay(e,{}),connected:!0}),t().actions.osmdLoad("assets/Angel_Beats_-_My_Soul_Your_Beats.xml")},osmdLoad:function(e){t().osmd.instance.load(e).then((function(){t().osmd.instance.render(),t().osmd.instance.cursor.show(),t().actions.osmdUpdate({loaded:!0})}))},osmdCursorNext:function(){t().osmd.instance.cursor.next()},osmdCursorPrevious:function(){var e=t().osmd.instance.cursor,n=e.iterator.currentTimeStamp.RealValue;if(n>0){var o=0;for(e.reset();e.iterator.currentTimeStamp.RealValue!==n;)o++,e.next();for(console.log("timestampIndex",o),o--,e.reset();o>0;)o--,e.next()}},osmdCursorReset:function(){t().osmd.instance.cursor.reset()},midiUpdate:function(n){e({midi:Object(u.a)(Object(u.a)({},t().midi),n)})},midiConnect:function(e){"running"===e.audioContext.state&&e.audioContext.suspend(),t().actions.midiUpdate({instance:e,connected:!0}),e.player.loader.waitLoad((function(){return t().actions.midiUpdate({loaded:!0})}))},locriaPlay:function(){var e=t().midi.instance,n=t().utils.osmdGetNotes(),o=Object(s.a)(n,2),a=o[0],r=o[1];t().actions.locriaStop(),a.length>0&&function(){var n=[],o=a[a.length-1];r.shift(),r.forEach((function(t,n){return r[n]=t+e.audioContext.currentTime})),r.push(o.time+o.duration+e.audioContext.currentTime),e.audioContext.resume();for(var i=function(){var o=Object(s.a)(u[c],2)[1],a=t().utils.midiInstrumentPreset(o[0].instrument);o.forEach((function(t){n.push(e.player.queueWaveTable(e.audioContext,e.audioContext.destination,a,e.audioContext.currentTime+t.time,t.note,t.duration,.1))}))},c=0,u=Object.entries(function(e,t){return e.reduce((function(e,n){var o=t(n);return e[o]||(e[o]=[]),e[o].push(n),e}),{})}(a,(function(e){return e.instrument})));c<u.length;c++)i();t().actions.midiUpdate({envelopes:n,playing:!0}),function n(){t().midi.playing&&(r.length>0?(e.audioContext.currentTime>=r[0]&&(r.shift(),t().osmd.instance.cursor.next()),setTimeout(n,0)):t().actions.locriaStop())}()}()},locriaStop:function(){t().midi.envelopes.forEach((function(e){return e.cancel()})),t().actions.midiUpdate({envelopes:[],playing:!1}),t().midi.instance.audioContext.suspend()}},utils:{osmdGetNotes:function(){var e=t().osmd.instance.cursor,n=e.iterator.currentTimeStamp.RealValue,o=[],a=[];console.log("gathering notes starting at",n);for(var r=e.iterator.clone();!r.EndReached;r.moveToNext())if(!(r.currentTimeStamp.RealValue<n)){o.push(4*(r.currentTimeStamp.RealValue-n)*60/145);var i,s=Object(c.a)(r.CurrentVoiceEntries);try{for(s.s();!(i=s.n()).done;){var u,l=i.value,m=Object(c.a)(l.Notes.filter((function(e){return null!==e&&0!==e.halfTone})));try{for(m.s();!(u=m.n()).done;){var d=u.value;if(!d.NoteTie||d.NoteTie.Notes[0]===d){var f=4*(d.NoteTie?d.NoteTie.Duration.RealValue:d.Length.RealValue)*60/145;a.push({instrument:d.ParentStaff.ParentInstrument.MidiInstrumentId,time:4*(r.currentTimeStamp.RealValue-n)*60/145,note:d.halfTone+12,duration:f})}}}catch(p){m.e(p)}finally{m.f()}}}catch(p){s.e(p)}finally{s.f()}}return[a,o]},midiInstrumentPreset:function(e){return window[t().midi.instance.player.loader.instrumentInfo(e).variable]}}}})),f=function(){var e=d((function(e){return e.osmd})).loaded,t=d((function(e){return e.midi})).loaded,n=d((function(e){return e.actions})),a=n.osmdCursorNext,r=n.osmdCursorPrevious,i=n.osmdCursorReset,c=n.locriaPlay,s=n.locriaStop;return console.log("[LocriaPlayback] render"),o.createElement("div",{className:"d-flex justify-content-center"},e&&t?o.createElement("div",{className:"btn-toolbar m-1",role:"toolbar"},o.createElement("div",{className:"btn-group btn-group-sm mr-2"},o.createElement("button",{type:"button",className:"btn btn-secondary",onClick:c},o.createElement("i",{className:"fas fa-play fa-fw"})),o.createElement("button",{type:"button",className:"btn btn-secondary",onClick:s},o.createElement("i",{className:"fas fa-stop fa-fw"}))),o.createElement("div",{className:"btn-group btn-group-sm"},o.createElement("button",{type:"button",className:"btn btn-secondary",onClick:i},o.createElement("i",{className:"fas fa-fast-backward fa-fw"})),o.createElement("button",{type:"button",className:"btn btn-secondary",onClick:r},o.createElement("i",{className:"fas fa-step-backward fa-fw"})),o.createElement("button",{type:"button",className:"btn btn-secondary",onClick:a},o.createElement("i",{className:"fas fa-step-forward fa-fw"})))):o.createElement("div",{className:"m-1"},"Loading..."))},p=function(){var e=d((function(e){return e.actions})).osmdConnect,t=o.useRef(null);return console.log("[LocriaOSMD] render"),o.useEffect((function(){e(t.current)}),[t,e]),o.createElement("div",{ref:t})},b=n(24),v=n.n(b),h=function(){var e=d((function(e){return e.actions})).midiConnect;return console.log("[LocriaMIDI] render"),o.createElement("div",{className:"d-none"},o.createElement(v.a,{ref:function(t){return e(t)},instruments:[0]}))},g=function(){return console.log("[Locria] render"),o.createElement(o.Fragment,null,o.createElement(h,null),o.createElement(o.StrictMode,null,o.createElement(f,null),o.createElement(p,null)))};var E=function(){return a.a.createElement(g,null)};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));i.a.render(a.a.createElement(E,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))}},[[25,1,2]]]);
//# sourceMappingURL=main.31a921c0.chunk.js.map